<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Triple Camera Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { 
      margin: 0; 
      padding: 0; 
      background: #000; 
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    
    .cameras-container {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      padding: 8px;
      min-height: 0;
    }
    
    .camera-panel {
      display: flex;
      flex-direction: column;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      overflow: hidden;
      min-height: 0;
    }
    
    .camera-header {
      background: rgba(0, 0, 0, 0.8);
      padding: 6px 12px;
      text-align: center;
      font-size: 13px;
      font-weight: 600;
      border-bottom: 1px solid #333;
      flex-shrink: 0;
    }
    
    .video-container { 
      flex: 1;
      display: flex; 
      justify-content: center; 
      align-items: center; 
      position: relative;
      padding: 8px;
      min-height: 0;
    }
    
    video { 
      max-width: 100%; 
      max-height: 100%; 
      object-fit: contain; 
      background: #000; 
      border-radius: 4px;
    }
    
    .camera-controls {
      background: rgba(0, 0, 0, 0.9);
      padding: 12px;
      display: flex;
      justify-content: center;
      border-top: 1px solid #333;
      flex-shrink: 0;
    }
    
    .ptz-pad {
      display: grid;
      grid-template-columns: repeat(3, 40px);
      grid-template-rows: repeat(3, 40px);
      gap: 3px;
    }
    
    .ptz-btn {
      background: #333;
      border: 1px solid #555;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      transition: all 0.2s;
      user-select: none;
    }
    
    .ptz-btn:hover {
      background: #444;
      border-color: #666;
    }
    
    .ptz-btn:active {
      background: #555;
      transform: scale(0.95);
    }
    
    .status {
      position: absolute;
      top: 6px;
      right: 6px;
      background: rgba(0, 0, 0, 0.8);
      padding: 3px 6px;
      border-radius: 3px;
      font-size: 10px;
      border: 1px solid #333;
    }
    
    .status.connected {
      border-color: #4a7a4a;
      background: rgba(0, 50, 0, 0.8);
    }
    
    .status.error {
      border-color: #7a4a4a;
      background: rgba(50, 0, 0, 0.8);
    }
    
    .settings-btn {
      position: absolute;
      top: 6px;
      left: 6px;
      background: rgba(0, 0, 0, 0.8);
      border: 1px solid #555;
      color: #fff;
      padding: 3px 6px;
      border-radius: 3px;
      font-size: 12px;
      cursor: pointer;
      user-select: none;
    }
    
    .settings-btn:hover {
      background: rgba(0, 0, 0, 0.9);
      border-color: #777;
    }
    
    .settings-menu {
      position: absolute;
      top: 30px;
      left: 6px;
      background: rgba(0, 0, 0, 0.95);
      border: 1px solid #555;
      border-radius: 4px;
      padding: 10px;
      display: none;
      min-width: 200px;
      z-index: 100;
    }
    
    .settings-menu.show {
      display: block;
    }
    
    .setting-item {
      margin-bottom: 8px;
    }
    
    .setting-item label {
      display: block;
      font-size: 11px;
      margin-bottom: 3px;
      opacity: 0.8;
    }
    
    .setting-item input {
      width: 100%;
      padding: 4px 6px;
      border: 1px solid #555;
      border-radius: 3px;
      background: #222;
      color: #fff;
      font-size: 11px;
    }
    
    .setting-item button {
      background: #333;
      border: 1px solid #555;
      color: #fff;
      padding: 4px 8px;
      border-radius: 3px;
      font-size: 11px;
      cursor: pointer;
      margin-right: 5px;
    }
    
    .setting-item button:hover {
      background: #444;
    }
    
    .reload-btn {
      position: absolute;
      top: 6px;
      right: 60px;
      background: rgba(0, 0, 0, 0.8);
      border: 1px solid #555;
      color: #fff;
      padding: 3px 6px;
      border-radius: 3px;
      font-size: 10px;
      cursor: pointer;
      user-select: none;
    }
    
    .reload-btn:hover {
      background: rgba(0, 0, 0, 0.9);
      border-color: #777;
    }
    
    .no-stream {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #888;
      font-size: 14px;
      text-align: center;
      pointer-events: none;
    }
    
    video.hidden {
      display: none;
    }
    
    @media (max-width: 1024px) {
      .cameras-container {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr 1fr 1fr;
        gap: 6px;
        padding: 6px;
      }
      
      .ptz-pad {
        grid-template-columns: repeat(3, 45px);
        grid-template-rows: repeat(3, 45px);
        gap: 4px;
      }
      
      .camera-controls {
        padding: 15px;
      }
      
      .camera-header {
        font-size: 14px;
        padding: 8px 15px;
      }
    }
    
    @media (max-width: 768px) {
      .ptz-pad {
        grid-template-columns: repeat(3, 42px);
        grid-template-rows: repeat(3, 42px);
      }
      
      .camera-controls {
        padding: 12px;
      }
    }
  </style>
  <script>
    // WebRTC WHEP connection
    async function playWHEP(videoEl, whepUrl, cameraName) {
      console.log(`Starting WHEP connection for ${cameraName}:`, whepUrl);
      updateStatus(cameraName, 'Connecting...', '');
      
      try {
        const pc = new RTCPeerConnection({ iceServers: [] });
        pc.addTransceiver('video', { direction: 'recvonly' });
        
        pc.ontrack = e => { 
          console.log(`Video track received for ${cameraName}`);
          if (!videoEl.srcObject) {
            videoEl.srcObject = e.streams[0];
            videoEl.classList.remove('hidden');
            hideNoStream(cameraName);
            updateStatus(cameraName, 'Connected', 'connected');
          }
        };
        
        pc.onconnectionstatechange = () => {
          console.log(`${cameraName} connection state:`, pc.connectionState);
          if (pc.connectionState === 'failed' || pc.connectionState === 'disconnected') {
            showNoStream(cameraName);
            updateStatus(cameraName, 'Connection Failed', 'error');
          }
        };
        
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        
        const response = await fetch(whepUrl, { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/sdp' }, 
          body: offer.sdp 
        });
        
        console.log(`WHEP response for ${cameraName}:`, response.status);
        if (!response.ok) {
          console.error(`WHEP failed for ${cameraName}:`, response.status, await response.text());
          showNoStream(cameraName);
          updateStatus(cameraName, 'Connection Failed', 'error');
          return;
        }
        
        const answer = await response.text();
        await pc.setRemoteDescription({ type: 'answer', sdp: answer });
        console.log(`WHEP connection established for ${cameraName}`);
        return pc;
      } catch (error) {
        console.error(`WHEP error for ${cameraName}:`, error);
        showNoStream(cameraName);
        updateStatus(cameraName, 'Connection Failed', 'error');
      }
    }
    
    // Camera IP configuration
    const defaultIPs = {
      robot: '192.168.4.181',
      table: '192.168.4.182', 
      ceiling: '192.168.4.183'
    };
    
    function getCurrentIP(camera) {
      return localStorage.getItem(`camera_ip_${camera}`) || defaultIPs[camera];
    }
    
    function setCurrentIP(camera, ip) {
      localStorage.setItem(`camera_ip_${camera}`, ip);
    }
    
    // PTZ control functions
    async function sendPTZCommand(camera, action, preset = null) {
      try {
        const url = preset ? 
          `/api/ptz/preset?camera=${camera}&preset=${preset}` :
          `/api/ptz/${action === 'stop' ? 'stop' : 'start'}?camera=${camera}&action=${action}`;
        
        console.log(`PTZ command for ${camera}:`, action, preset ? `preset ${preset}` : '');
        const response = await fetch(url, { method: 'POST' });
        const result = await response.json();
        
        if (!response.ok) {
          console.error(`PTZ command failed for ${camera}:`, result);
          updateStatus(camera, 'PTZ Error', 'error');
          setTimeout(() => updateStatus(camera, 'Connected', 'connected'), 2000);
        }
        
        return response.ok;
      } catch (error) {
        console.error(`PTZ request failed for ${camera}:`, error);
        updateStatus(camera, 'PTZ Error', 'error');
        setTimeout(() => updateStatus(camera, 'Connected', 'connected'), 2000);
        return false;
      }
    }
    
    // Settings menu functions
    function toggleSettings(camera) {
      const menu = document.getElementById(`settings-menu-${camera}`);
      const isShown = menu.classList.contains('show');
      
      // Hide all other menus
      document.querySelectorAll('.settings-menu').forEach(m => m.classList.remove('show'));
      
      if (!isShown) {
        menu.classList.add('show');
        // Set current IP in input
        const input = menu.querySelector('input');
        input.value = getCurrentIP(camera);
      }
    }
    
    function saveIP(camera) {
      const menu = document.getElementById(`settings-menu-${camera}`);
      const input = menu.querySelector('input');
      const newIP = input.value.trim();
      
      if (!newIP.match(/^\d+\.\d+\.\d+\.\d+$/)) {
        alert('Invalid IP address format');
        return;
      }
      
      setCurrentIP(camera, newIP);
      menu.classList.remove('show');
      updateStatus(camera, 'IP Updated', 'connected');
      console.log(`${camera} IP updated to ${newIP}`);
      
      // Optionally restart the stream with new IP
      setTimeout(() => {
        updateStatus(camera, 'Reconnecting...', '');
        // Here you could add logic to restart the stream if needed
      }, 1000);
    }
    
    function resetIP(camera) {
      const menu = document.getElementById(`settings-menu-${camera}`);
      const input = menu.querySelector('input');
      input.value = defaultIPs[camera];
    }
    
    function updateStatus(camera, message, type = '') {
      const status = document.getElementById(`status-${camera}`);
      if (status) {
        status.textContent = message;
        status.className = `status ${type}`;
      }
    }
    
    function showNoStream(camera) {
      const video = document.getElementById(`v${camera.charAt(0).toUpperCase() + camera.slice(1)}`);
      const noStream = document.getElementById(`no-stream-${camera}`);
      if (video) video.classList.add('hidden');
      if (noStream) noStream.style.display = 'block';
    }
    
    function hideNoStream(camera) {
      const noStream = document.getElementById(`no-stream-${camera}`);
      if (noStream) noStream.style.display = 'none';
    }
    
    function reloadCamera(camera) {
      console.log(`Reloading ${camera} camera...`);
      updateStatus(camera, 'Reloading...', '');
      
      // Stop existing stream
      const video = document.getElementById(`v${camera.charAt(0).toUpperCase() + camera.slice(1)}`);
      if (video && video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
        video.srcObject = null;
      }
      
      showNoStream(camera);
      
      // Restart stream
      setTimeout(() => {
        const HOST = (window.PUBLIC_HOST && window.PUBLIC_HOST.length) ? window.PUBLIC_HOST : location.host;
        const base = `${location.protocol}//${HOST}`;
        
        playWHEP(video, `${base}/${camera}/whep`, camera).then(() => {
          // Success handled in playWHEP
        }).catch(() => {
          updateStatus(camera, 'Reload Failed', 'error');
        });
      }, 1000);
    }
    
    // Event handlers for a specific camera
    function setupCameraControls(camera) {
      document.querySelectorAll(`[data-camera="${camera}"] .ptz-btn`).forEach(btn => {
        let isPressed = false;
        
        btn.addEventListener('mousedown', (e) => {
          e.preventDefault();
          const action = btn.dataset.action;
          
          if (action === 'stop') {
            sendPTZCommand(camera, 'stop');
            return;
          }
          
          isPressed = true;
          console.log(`Starting ${action} movement for ${camera} (hold to continue)`);
          sendPTZCommand(camera, action);
        });
        
        btn.addEventListener('mouseup', (e) => {
          e.preventDefault();
          if (isPressed) {
            isPressed = false;
            console.log(`Button released for ${camera} - stopping movement`);
            sendPTZCommand(camera, 'stop');
          }
        });
        
        btn.addEventListener('mouseleave', (e) => {
          e.preventDefault();
          if (isPressed) {
            isPressed = false;
            console.log(`Mouse left button for ${camera} - stopping movement`);
            sendPTZCommand(camera, 'stop');
          }
        });
        
        // Touch events for mobile
        btn.addEventListener('touchstart', (e) => {
          e.preventDefault();
          const action = btn.dataset.action;
          
          if (action === 'stop') {
            sendPTZCommand(camera, 'stop');
            return;
          }
          
          isPressed = true;
          console.log(`Touch starting ${action} movement for ${camera}`);
          sendPTZCommand(camera, action);
        });
        
        btn.addEventListener('touchend', (e) => {
          e.preventDefault();
          if (isPressed) {
            isPressed = false;
            console.log(`Touch ended for ${camera} - stopping movement`);
            sendPTZCommand(camera, 'stop');
          }
        });
      });
    }
    
    // Initialize
    const HOST = (window.PUBLIC_HOST && window.PUBLIC_HOST.length) ? window.PUBLIC_HOST : location.host;
    window.addEventListener('DOMContentLoaded', () => {
      const base = `${location.protocol}//${HOST}`;
      
      // Show no-stream initially for all cameras
      showNoStream('robot');
      showNoStream('table');
      showNoStream('ceiling');
      
      // Start all three video streams
      playWHEP(document.getElementById('vRobot'), `${base}/robot/whep`, 'robot').catch(() => {
        updateStatus('robot', 'Connection Failed', 'error');
      });
      
      playWHEP(document.getElementById('vTable'), `${base}/table/whep`, 'table').catch(() => {
        updateStatus('table', 'Connection Failed', 'error');
      });
      
      playWHEP(document.getElementById('vCeiling'), `${base}/ceiling/whep`, 'ceiling').catch(() => {
        updateStatus('ceiling', 'Connection Failed', 'error');
      });
      
      // Setup controls for all three cameras
      setupCameraControls('robot');
      setupCameraControls('table');
      setupCameraControls('ceiling');
      
      // Close settings menus when clicking outside
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.settings-btn') && !e.target.closest('.settings-menu')) {
          document.querySelectorAll('.settings-menu').forEach(m => m.classList.remove('show'));
        }
      });
    });
  </script>
</head>
<body>
  <div class="cameras-container">
    <!-- Robot Camera -->
    <div class="camera-panel">
      <div class="camera-header">Robot Camera</div>
      <div class="video-container">
        <video id="vRobot" autoplay playsinline muted></video>
        <div id="no-stream-robot" class="no-stream" style="display: none;">No Stream</div>
        <div id="status-robot" class="status">Connecting...</div>
        <div class="reload-btn" onclick="reloadCamera('robot')">🔄</div>
        <div class="settings-btn" onclick="toggleSettings('robot')">⋯</div>
        <div id="settings-menu-robot" class="settings-menu">
          <div class="setting-item">
            <label>Camera IP Address:</label>
            <input type="text" placeholder="192.168.4.181">
          </div>
          <div class="setting-item">
            <button onclick="saveIP('robot')">Save</button>
            <button onclick="resetIP('robot')">Reset</button>
          </div>
        </div>
      </div>
      <div class="camera-controls" data-camera="robot">
        <div class="ptz-pad">
          <div></div>
          <button class="ptz-btn" data-action="up">↑</button>
          <div></div>
          <button class="ptz-btn" data-action="left">←</button>
          <button class="ptz-btn" data-action="stop">⏹</button>
          <button class="ptz-btn" data-action="right">→</button>
          <div></div>
          <button class="ptz-btn" data-action="down">↓</button>
          <div></div>
        </div>
      </div>
    </div>
    
    <!-- Table Camera -->
    <div class="camera-panel">
      <div class="camera-header">Table Camera</div>
      <div class="video-container">
        <video id="vTable" autoplay playsinline muted></video>
        <div id="no-stream-table" class="no-stream" style="display: none;">No Stream</div>
        <div id="status-table" class="status">Connecting...</div>
        <div class="reload-btn" onclick="reloadCamera('table')">🔄</div>
        <div class="settings-btn" onclick="toggleSettings('table')">⋯</div>
        <div id="settings-menu-table" class="settings-menu">
          <div class="setting-item">
            <label>Camera IP Address:</label>
            <input type="text" placeholder="192.168.4.182">
          </div>
          <div class="setting-item">
            <button onclick="saveIP('table')">Save</button>
            <button onclick="resetIP('table')">Reset</button>
          </div>
        </div>
      </div>
      <div class="camera-controls" data-camera="table">
        <div class="ptz-pad">
          <div></div>
          <button class="ptz-btn" data-action="up">↑</button>
          <div></div>
          <button class="ptz-btn" data-action="left">←</button>
          <button class="ptz-btn" data-action="stop">⏹</button>
          <button class="ptz-btn" data-action="right">→</button>
          <div></div>
          <button class="ptz-btn" data-action="down">↓</button>
          <div></div>
        </div>
      </div>
    </div>
    
    <!-- Ceiling Camera -->
    <div class="camera-panel">
      <div class="camera-header">Ceiling Camera</div>
      <div class="video-container">
        <video id="vCeiling" autoplay playsinline muted></video>
        <div id="no-stream-ceiling" class="no-stream" style="display: none;">No Stream</div>
        <div id="status-ceiling" class="status">Connecting...</div>
        <div class="reload-btn" onclick="reloadCamera('ceiling')">🔄</div>
        <div class="settings-btn" onclick="toggleSettings('ceiling')">⋯</div>
        <div id="settings-menu-ceiling" class="settings-menu">
          <div class="setting-item">
            <label>Camera IP Address:</label>
            <input type="text" placeholder="192.168.4.183">
          </div>
          <div class="setting-item">
            <button onclick="saveIP('ceiling')">Save</button>
            <button onclick="resetIP('ceiling')">Reset</button>
          </div>
        </div>
      </div>
      <div class="camera-controls" data-camera="ceiling">
        <div class="ptz-pad">
          <div></div>
          <button class="ptz-btn" data-action="up">↑</button>
          <div></div>
          <button class="ptz-btn" data-action="left">←</button>
          <button class="ptz-btn" data-action="stop">⏹</button>
          <button class="ptz-btn" data-action="right">→</button>
          <div></div>
          <button class="ptz-btn" data-action="down">↓</button>
          <div></div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>