<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Robot Camera Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { 
      margin: 0; 
      padding: 0; 
      background: #000; 
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    
    .video-container { 
      flex: 1; 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      position: relative;
      min-height: 60vh;
    }
    
    video { 
      max-width: 100%; 
      max-height: 100%; 
      object-fit: contain; 
      background: #000; 
      border-radius: 8px;
    }
    
    .controls {
      background: rgba(0, 0, 0, 0.9);
      padding: 20px;
      display: flex;
      justify-content: center;
      gap: 30px;
      flex-wrap: wrap;
      border-top: 1px solid #333;
    }
    
    .control-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    
    .control-group h3 {
      margin: 0;
      font-size: 14px;
      opacity: 0.8;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .ptz-pad {
      display: grid;
      grid-template-columns: repeat(3, 50px);
      grid-template-rows: repeat(3, 50px);
      gap: 4px;
    }
    
    .ptz-btn {
      background: #333;
      border: 1px solid #555;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.2s;
      user-select: none;
    }
    
    .ptz-btn:hover {
      background: #444;
      border-color: #666;
    }
    
    .ptz-btn:active {
      background: #555;
      transform: scale(0.95);
    }
    
    .ptz-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    
    .zoom-controls {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .zoom-btn {
      background: #2a4a2a;
      border: 1px solid #3a5a3a;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
      padding: 12px 16px;
      font-size: 14px;
      transition: all 0.2s;
      min-width: 60px;
    }
    
    .zoom-btn:hover {
      background: #3a5a3a;
    }
    
    .zoom-btn:active {
      background: #4a6a4a;
      transform: scale(0.95);
    }
    
    .presets {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      max-width: 200px;
    }
    
    .preset-btn {
      background: #2a4a7a;
      border: 1px solid #3a5a8a;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
      padding: 8px 12px;
      font-size: 12px;
      transition: all 0.2s;
      min-width: 50px;
    }
    
    .preset-btn:hover {
      background: #3a5a8a;
    }
    
    .preset-btn:active {
      background: #4a6a9a;
      transform: scale(0.95);
    }
    
    .status {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.8);
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      border: 1px solid #333;
    }
    
    .status.connected {
      border-color: #4a7a4a;
      background: rgba(0, 50, 0, 0.8);
    }
    
    .status.error {
      border-color: #7a4a4a;
      background: rgba(50, 0, 0, 0.8);
    }
    
    @media (max-width: 768px) {
      .controls {
        gap: 20px;
        padding: 15px;
      }
      
      .ptz-pad {
        grid-template-columns: repeat(3, 45px);
        grid-template-rows: repeat(3, 45px);
      }
      
      .zoom-btn, .preset-btn {
        padding: 10px 12px;
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="video-container">
    <video id="vRobot" autoplay playsinline muted></video>
    <div id="status" class="status">Connecting...</div>
  </div>
  
  <div class="controls">
    <div class="control-group">
      <h3>Pan & Tilt</h3>
      <div class="ptz-pad">
        <button class="ptz-btn" data-action="up-left">↖</button>
        <button class="ptz-btn" data-action="up">↑</button>
        <button class="ptz-btn" data-action="up-right">↗</button>
        <button class="ptz-btn" data-action="left">←</button>
        <button class="ptz-btn" data-action="stop">⏹</button>
        <button class="ptz-btn" data-action="right">→</button>
        <button class="ptz-btn" data-action="down-left">↙</button>
        <button class="ptz-btn" data-action="down">↓</button>
        <button class="ptz-btn" data-action="down-right">↘</button>
      </div>
    </div>
    
    <div class="control-group">
      <h3>Zoom</h3>
      <div class="zoom-controls">
        <button class="zoom-btn" data-action="zoom-in">+</button>
        <button class="zoom-btn" data-action="zoom-out">-</button>
      </div>
    </div>
    
    <div class="control-group">
      <h3>Presets</h3>
      <div class="presets">
        <button class="preset-btn" data-preset="1">1</button>
        <button class="preset-btn" data-preset="2">2</button>
        <button class="preset-btn" data-preset="3">3</button>
        <button class="preset-btn" data-preset="4">4</button>
        <button class="preset-btn" data-preset="5">5</button>
        <button class="preset-btn" data-preset="6">6</button>
      </div>
    </div>
  </div>

  <script>
    // WebRTC WHEP connection
    async function playWHEP(videoEl, whepUrl) {
      const pc = new RTCPeerConnection({ iceServers: [] });
      pc.addTransceiver('video', { direction: 'recvonly' });
      pc.ontrack = e => { 
        if (!videoEl.srcObject) {
          videoEl.srcObject = e.streams[0];
          updateStatus('Connected', 'connected');
        }
      };
      
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      
      console.log('WHEP POST', whepUrl);
      const res = await fetch(whepUrl, { 
        method: 'POST', 
        headers: { 'Content-Type': 'application/sdp' }, 
        body: offer.sdp 
      });
      
      console.log('WHEP status', res.status);
      if (!res.ok) { 
        console.error('WHEP POST failed (%d/%s)', res.status, res.statusText);
        updateStatus('Connection Failed', 'error');
        return; 
      }
      
      const answer = await res.text();
      await pc.setRemoteDescription({ type: 'answer', sdp: answer });
      return pc;
    }
    
    // PTZ control functions
    async function sendPTZCommand(action, preset = null) {
      try {
        const url = preset ? 
          `/api/ptz/preset?camera=robot&preset=${preset}` :
          `/api/ptz/${action === 'stop' ? 'stop' : 'start'}?camera=robot&action=${action}`;
        
        const response = await fetch(url, { method: 'POST' });
        const result = await response.text();
        
        if (!response.ok) {
          console.error('PTZ command failed:', result);
          updateStatus('PTZ Error', 'error');
          setTimeout(() => updateStatus('Connected', 'connected'), 2000);
        }
        
        return response.ok;
      } catch (error) {
        console.error('PTZ request failed:', error);
        updateStatus('PTZ Error', 'error');
        setTimeout(() => updateStatus('Connected', 'connected'), 2000);
        return false;
      }
    }
    
    function updateStatus(message, type = '') {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = `status ${type}`;
    }
    
    // Event handlers
    function setupControls() {
      // PTZ direction controls
      document.querySelectorAll('.ptz-btn').forEach(btn => {
        btn.addEventListener('mousedown', () => {
          const action = btn.dataset.action;
          sendPTZCommand(action);
        });
        
        btn.addEventListener('mouseup', () => {
          sendPTZCommand('stop');
        });
        
        btn.addEventListener('mouseleave', () => {
          sendPTZCommand('stop');
        });
      });
      
      // Zoom controls
      document.querySelectorAll('.zoom-btn').forEach(btn => {
        btn.addEventListener('mousedown', () => {
          const action = btn.dataset.action;
          sendPTZCommand(action);
        });
        
        btn.addEventListener('mouseup', () => {
          sendPTZCommand('stop');
        });
        
        btn.addEventListener('mouseleave', () => {
          sendPTZCommand('stop');
        });
      });
      
      // Preset controls
      document.querySelectorAll('.preset-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const preset = btn.dataset.preset;
          sendPTZCommand(null, preset);
        });
      });
    }
    
    // Initialize
    window.addEventListener('DOMContentLoaded', () => {
      const HOST = (window.PUBLIC_HOST && window.PUBLIC_HOST.length) ? window.PUBLIC_HOST : location.host;
      const base = `${location.protocol}//${HOST}`;
      
      // Start video stream
      playWHEP(document.getElementById('vRobot'), `${base}/robot/whep`);
      
      // Setup controls
      setupControls();
    });
  </script>
</body>
</html>