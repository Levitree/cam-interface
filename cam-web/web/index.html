<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Robot Camera Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { 
      margin: 0; 
      padding: 0; 
      background: #000; 
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden; /* Prevent scrolling */
    }
    
    .video-container { 
      flex: 1;
      display: flex; 
      justify-content: center; 
      align-items: center; 
      position: relative;
      padding: 10px;
      min-height: 0; /* Allow flex shrinking */
    }
    
    video { 
      max-width: 100%; 
      max-height: 100%; 
      object-fit: contain; 
      background: #000; 
      border-radius: 8px;
    }
    
    .controls {
      background: rgba(0, 0, 0, 0.9);
      padding: 15px;
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
      border-top: 1px solid #333;
      flex-shrink: 0; /* Don't shrink controls */
      max-height: 180px; /* Limit control height */
      overflow: auto; /* Scroll controls if needed */
    }
    
    .control-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    
    .control-group h3 {
      margin: 0;
      font-size: 14px;
      opacity: 0.8;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .ptz-pad {
      display: grid;
      grid-template-columns: repeat(3, 50px);
      grid-template-rows: repeat(3, 50px);
      gap: 4px;
    }
    
    .ptz-btn {
      background: #333;
      border: 1px solid #555;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.2s;
      user-select: none;
    }
    
    .ptz-btn:hover {
      background: #444;
      border-color: #666;
    }
    
    .ptz-btn:active {
      background: #555;
      transform: scale(0.95);
    }
    

    
    .status {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.8);
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      border: 1px solid #333;
    }
    
    .status.connected {
      border-color: #4a7a4a;
      background: rgba(0, 50, 0, 0.8);
    }
    
    .status.error {
      border-color: #7a4a4a;
      background: rgba(50, 0, 0, 0.8);
    }
    
    @media (max-width: 768px) {
      .controls {
        gap: 15px;
        padding: 10px;
        max-height: 160px; /* Smaller on mobile */
      }
      
      .ptz-pad {
        grid-template-columns: repeat(3, 40px);
        grid-template-rows: repeat(3, 40px);
        gap: 3px;
      }
      

      
      .control-group h3 {
        font-size: 12px;
      }
    }
    
    @media (max-height: 600px) {
      .controls {
        max-height: 120px; /* Even smaller on short screens */
        padding: 8px;
      }
      
      .ptz-pad {
        grid-template-columns: repeat(3, 35px);
        grid-template-rows: repeat(3, 35px);
      }
      
      .video-container {
        padding: 5px;
      }
    }
  </style>
  <script>
    // Allow HTTP for local dev (proxied by Express)
  </script>
  <script>
    async function playWHEP(videoEl, whepUrl){
      console.log('Starting WHEP connection to:', whepUrl);
      const pc = new RTCPeerConnection({ iceServers: [] });
      pc.addTransceiver('video', { direction: 'recvonly' });
      pc.ontrack = e => { 
        console.log('Video track received');
        if (!videoEl.srcObject) videoEl.srcObject = e.streams[0]; 
      };
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      
      const response = await fetch(whepUrl, { 
        method: 'POST', 
        headers: { 'Content-Type': 'application/sdp' }, 
        body: offer.sdp 
      });
      
      console.log('WHEP response:', response.status);
      if (!response.ok) {
        console.error('WHEP failed:', response.status, await response.text());
        return;
      }
      
      const answer = await response.text();
      await pc.setRemoteDescription({ type: 'answer', sdp: answer });
      console.log('WHEP connection established');
      return pc;
    }
    // PTZ control functions
    async function sendPTZCommand(action, preset = null) {
      try {
        const url = preset ? 
          `/api/ptz/preset?camera=robot&preset=${preset}` :
          `/api/ptz/${action === 'stop' ? 'stop' : 'start'}?camera=robot&action=${action}`;
        
        console.log('PTZ command:', action, preset ? `preset ${preset}` : '');
        const response = await fetch(url, { method: 'POST' });
        const result = await response.json();
        
        if (!response.ok) {
          console.error('PTZ command failed:', result);
          updateStatus('PTZ Error', 'error');
          setTimeout(() => updateStatus('Connected', 'connected'), 2000);
        }
        
        return response.ok;
      } catch (error) {
        console.error('PTZ request failed:', error);
        updateStatus('PTZ Error', 'error');
        setTimeout(() => updateStatus('Connected', 'connected'), 2000);
        return false;
      }
    }
    
    function updateStatus(message, type = '') {
      const status = document.getElementById('status');
      if (status) {
        status.textContent = message;
        status.className = `status ${type}`;
      }
    }
    
    // Event handlers
    function setupControls() {
      // PTZ direction controls - short tap movements
      document.querySelectorAll('.ptz-btn').forEach(btn => {
        let moveTimeout;
        
        btn.addEventListener('mousedown', () => {
          const action = btn.dataset.action;
          if (action === 'stop') {
            sendPTZCommand('stop');
            return;
          }
          
          // Start movement
          sendPTZCommand(action);
          
          // Auto-stop after short duration for tap movements
          moveTimeout = setTimeout(() => {
            sendPTZCommand('stop');
          }, 150); // 150ms movement duration - very short taps
        });
        
        btn.addEventListener('mouseup', () => {
          if (moveTimeout) {
            clearTimeout(moveTimeout);
            moveTimeout = null;
          }
          sendPTZCommand('stop');
        });
        
        btn.addEventListener('mouseleave', () => {
          if (moveTimeout) {
            clearTimeout(moveTimeout);
            moveTimeout = null;
          }
          sendPTZCommand('stop');
        });
      });
    }
    
    // Initialize
    const HOST = (window.PUBLIC_HOST && window.PUBLIC_HOST.length) ? window.PUBLIC_HOST : location.host;
    window.addEventListener('DOMContentLoaded', () => {
      const base = `${location.protocol}//${HOST}`;
      
      // Start video stream
      playWHEP(document.getElementById('vRobot'), `${base}/robot/whep`).then(() => {
        updateStatus('Connected', 'connected');
      }).catch(() => {
        updateStatus('Connection Failed', 'error');
      });
      
      // Setup controls
      setupControls();
    });
  </script>
</head>
<body>
  <div class="video-container">
    <video id="vRobot" autoplay playsinline muted></video>
    <div id="status" class="status">Connecting...</div>
  </div>
  
  <div class="controls">
    <div class="control-group">
      <h3>Camera Control</h3>
      <div class="ptz-pad">
        <div></div>
        <button class="ptz-btn" data-action="up">↑</button>
        <div></div>
        <button class="ptz-btn" data-action="left">←</button>
        <button class="ptz-btn" data-action="stop">⏹</button>
        <button class="ptz-btn" data-action="right">→</button>
        <div></div>
        <button class="ptz-btn" data-action="down">↓</button>
        <div></div>
      </div>
    </div>
  </div>
</body>
</html>

