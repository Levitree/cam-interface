<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Dual Camera Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { 
      margin: 0; 
      padding: 0; 
      background: #000; 
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    
    .cameras-container {
      flex: 1;
      display: flex;
      gap: 10px;
      padding: 10px;
      min-height: 0;
    }
    
    .camera-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      overflow: hidden;
    }
    
    .camera-header {
      background: rgba(0, 0, 0, 0.8);
      padding: 8px 15px;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      border-bottom: 1px solid #333;
    }
    
    .video-container { 
      flex: 1;
      display: flex; 
      justify-content: center; 
      align-items: center; 
      position: relative;
      padding: 10px;
      min-height: 0;
    }
    
    video { 
      max-width: 100%; 
      max-height: 100%; 
      object-fit: contain; 
      background: #000; 
      border-radius: 6px;
    }
    
    .camera-controls {
      background: rgba(0, 0, 0, 0.9);
      padding: 15px;
      display: flex;
      justify-content: center;
      border-top: 1px solid #333;
    }
    
    .ptz-pad {
      display: grid;
      grid-template-columns: repeat(3, 45px);
      grid-template-rows: repeat(3, 45px);
      gap: 4px;
    }
    
    .ptz-btn {
      background: #333;
      border: 1px solid #555;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.2s;
      user-select: none;
    }
    
    .ptz-btn:hover {
      background: #444;
      border-color: #666;
    }
    
    .ptz-btn:active {
      background: #555;
      transform: scale(0.95);
    }
    
    .status {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0, 0, 0, 0.8);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      border: 1px solid #333;
    }
    
    .status.connected {
      border-color: #4a7a4a;
      background: rgba(0, 50, 0, 0.8);
    }
    
    .status.error {
      border-color: #7a4a4a;
      background: rgba(50, 0, 0, 0.8);
    }
    
    @media (max-width: 768px) {
      .cameras-container {
        flex-direction: column;
        gap: 5px;
        padding: 5px;
      }
      
      .ptz-pad {
        grid-template-columns: repeat(3, 40px);
        grid-template-rows: repeat(3, 40px);
        gap: 3px;
      }
      
      .camera-controls {
        padding: 10px;
      }
      
      .camera-header {
        font-size: 12px;
        padding: 6px 10px;
      }
    }
  </style>
  <script>
    // WebRTC WHEP connection
    async function playWHEP(videoEl, whepUrl, cameraName) {
      console.log(`Starting WHEP connection for ${cameraName}:`, whepUrl);
      const pc = new RTCPeerConnection({ iceServers: [] });
      pc.addTransceiver('video', { direction: 'recvonly' });
      pc.ontrack = e => { 
        console.log(`Video track received for ${cameraName}`);
        if (!videoEl.srcObject) videoEl.srcObject = e.streams[0]; 
      };
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      
      const response = await fetch(whepUrl, { 
        method: 'POST', 
        headers: { 'Content-Type': 'application/sdp' }, 
        body: offer.sdp 
      });
      
      console.log(`WHEP response for ${cameraName}:`, response.status);
      if (!response.ok) {
        console.error(`WHEP failed for ${cameraName}:`, response.status, await response.text());
        return;
      }
      
      const answer = await response.text();
      await pc.setRemoteDescription({ type: 'answer', sdp: answer });
      console.log(`WHEP connection established for ${cameraName}`);
      return pc;
    }
    
    // PTZ control functions
    async function sendPTZCommand(camera, action, preset = null) {
      try {
        const url = preset ? 
          `/api/ptz/preset?camera=${camera}&preset=${preset}` :
          `/api/ptz/${action === 'stop' ? 'stop' : 'start'}?camera=${camera}&action=${action}`;
        
        console.log(`PTZ command for ${camera}:`, action, preset ? `preset ${preset}` : '');
        const response = await fetch(url, { method: 'POST' });
        const result = await response.json();
        
        if (!response.ok) {
          console.error(`PTZ command failed for ${camera}:`, result);
          updateStatus(camera, 'PTZ Error', 'error');
          setTimeout(() => updateStatus(camera, 'Connected', 'connected'), 2000);
        }
        
        return response.ok;
      } catch (error) {
        console.error(`PTZ request failed for ${camera}:`, error);
        updateStatus(camera, 'PTZ Error', 'error');
        setTimeout(() => updateStatus(camera, 'Connected', 'connected'), 2000);
        return false;
      }
    }
    
    function updateStatus(camera, message, type = '') {
      const status = document.getElementById(`status-${camera}`);
      if (status) {
        status.textContent = message;
        status.className = `status ${type}`;
      }
    }
    
    // Event handlers for a specific camera
    function setupCameraControls(camera) {
      document.querySelectorAll(`[data-camera="${camera}"] .ptz-btn`).forEach(btn => {
        let isPressed = false;
        
        btn.addEventListener('mousedown', (e) => {
          e.preventDefault();
          const action = btn.dataset.action;
          
          if (action === 'stop') {
            sendPTZCommand(camera, 'stop');
            return;
          }
          
          isPressed = true;
          console.log(`Starting ${action} movement for ${camera} (hold to continue)`);
          sendPTZCommand(camera, action);
        });
        
        btn.addEventListener('mouseup', (e) => {
          e.preventDefault();
          if (isPressed) {
            isPressed = false;
            console.log(`Button released for ${camera} - stopping movement`);
            sendPTZCommand(camera, 'stop');
          }
        });
        
        btn.addEventListener('mouseleave', (e) => {
          e.preventDefault();
          if (isPressed) {
            isPressed = false;
            console.log(`Mouse left button for ${camera} - stopping movement`);
            sendPTZCommand(camera, 'stop');
          }
        });
        
        // Touch events for mobile
        btn.addEventListener('touchstart', (e) => {
          e.preventDefault();
          const action = btn.dataset.action;
          
          if (action === 'stop') {
            sendPTZCommand(camera, 'stop');
            return;
          }
          
          isPressed = true;
          console.log(`Touch starting ${action} movement for ${camera}`);
          sendPTZCommand(camera, action);
        });
        
        btn.addEventListener('touchend', (e) => {
          e.preventDefault();
          if (isPressed) {
            isPressed = false;
            console.log(`Touch ended for ${camera} - stopping movement`);
            sendPTZCommand(camera, 'stop');
          }
        });
      });
    }
    
    // Initialize
    const HOST = (window.PUBLIC_HOST && window.PUBLIC_HOST.length) ? window.PUBLIC_HOST : location.host;
    window.addEventListener('DOMContentLoaded', () => {
      const base = `${location.protocol}//${HOST}`;
      
      // Start both video streams
      playWHEP(document.getElementById('vRobot'), `${base}/robot/whep`, 'robot').then(() => {
        updateStatus('robot', 'Connected', 'connected');
      }).catch(() => {
        updateStatus('robot', 'Connection Failed', 'error');
      });
      
      playWHEP(document.getElementById('vTable'), `${base}/table/whep`, 'table').then(() => {
        updateStatus('table', 'Connected', 'connected');
      }).catch(() => {
        updateStatus('table', 'Connection Failed', 'error');
      });
      
      // Setup controls for both cameras
      setupCameraControls('robot');
      setupCameraControls('table');
    });
  </script>
</head>
<body>
  <div class="cameras-container">
    <!-- Robot Camera -->
    <div class="camera-panel">
      <div class="camera-header">Robot Camera</div>
      <div class="video-container">
        <video id="vRobot" autoplay playsinline muted></video>
        <div id="status-robot" class="status">Connecting...</div>
      </div>
      <div class="camera-controls" data-camera="robot">
        <div class="ptz-pad">
          <div></div>
          <button class="ptz-btn" data-action="up">↑</button>
          <div></div>
          <button class="ptz-btn" data-action="left">←</button>
          <button class="ptz-btn" data-action="stop">⏹</button>
          <button class="ptz-btn" data-action="right">→</button>
          <div></div>
          <button class="ptz-btn" data-action="down">↓</button>
          <div></div>
        </div>
      </div>
    </div>
    
    <!-- Table Camera -->
    <div class="camera-panel">
      <div class="camera-header">Table Camera</div>
      <div class="video-container">
        <video id="vTable" autoplay playsinline muted></video>
        <div id="status-table" class="status">Connecting...</div>
      </div>
      <div class="camera-controls" data-camera="table">
        <div class="ptz-pad">
          <div></div>
          <button class="ptz-btn" data-action="up">↑</button>
          <div></div>
          <button class="ptz-btn" data-action="left">←</button>
          <button class="ptz-btn" data-action="stop">⏹</button>
          <button class="ptz-btn" data-action="right">→</button>
          <div></div>
          <button class="ptz-btn" data-action="down">↓</button>
          <div></div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>